<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel='shortcut icon' href='img/favicon.ico' type='image/x-icon'/>

    <title>SnmpCG - Admin Interface</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/vendor/bootstrap.min.css" rel="stylesheet">
    <link href="css/dataTables.bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
      <script src="js/vendor/html5shiv.js"></script>
      <script src="js/vendor/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html">SnmpCG</a>
        </div>
        <ul class="nav navbar-nav">
          <li><a href="index.html">Sources</a></li>
        </ul>
        <button id="removeBtn" type="button" class="btn btn-primary navbar-btn navbar-right" onclick="delSource()">Remove</button>
      </div>
    </nav>
    <!-- page content -->
    <div class="container">
        	<h2>Source <span id="address"></span></h2>
			<h5>last poll @ <span id="updated"></span></h5>
		<div class="panel panel-default">
  			<div class="panel-heading"><span id="status" class="label"></span> <span id="sysName"></span></div>
  			<div class="panel-body">
    			<span id="sysDescr" class="small"></span>
  			</div>
			<ul class="list-group">	
				<li class="list-group-item small"><label>Uptime:</label> <span id="sysUptime"></span>
        		<li class="list-group-item small"><label>ifNumber:</label> <span id="ifNumber"></span>
        	</ul>
		</div>
		
		  <table id="ifTable" class="table table-condensed">
          <thead>
            <tr>
              <th></th>
              <th>ifIndex</th>
              <th>ifDescr</th>
              <th>pollStatus</th>
              <th>in_bytes</th>
              <th>out_bytes</th>
            </tr>
          </thead>
          <tbody>
          </tbody>  
        </table>
		</div>
    </div>
    <!-- /.container -->

    <!-- jQuery (necessary for Flat UI's JavaScript plugins) -->
    <script src="js/vendor/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/datatables.min.js"></script>
    <!-- script src="js/jquery.dataTables.min.js"></script -->
    <script src="js/dataTables.bootstrap.min.js"></script>
    <script>
        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    return sParameterName[1];
                }
            }
        }

    var ip = getUrlParameter("ip");
    $("#address").text(ip);
    $("#removeBtn").text("Remove "+ip);
    
    function delSource() {
    	$.ajax({
    		url: "/api/v1/sources/"+ip,
    		type: "DELETE",
    		success: function(result) {
    			window.location.href = "index.html";
    		}
		});
    }
    
    function pad(v) {
    	return v<10?"0"+v:v;
    }
    
    function uptime(timeticks) {
    	var tt = timeticks;
    	var d = Math.floor(tt / 8640000);
    	tt %= 8640000;
    	var h = Math.floor(tt / 360000);
    	tt %= 360000;
    	var m = Math.floor(tt / 6000);
    	tt %= 6000;
    	var s= Math.floor( tt / 100);
    	tt %= 100;
    	return d+" days, "+pad(h)+":"+pad(m)+":"+pad(s)+"."+tt; 
    }
    
    $.ajax({
    	url: "/api/v1/sources/"+ip,
    	success: function(source){
    		$("#status").text(source.Status);
    		if (source.Status == 'UNKNOWN') {
            	$("#status").addClass("label-default");
            } 
            else {
    			$("#updated").text(new Date(source.pollTime).toLocaleString());
 				if (source.Status == 'SUCCESS') {
            		$("#status").addClass("label-success");
            	} 
            	if (source.Status == 'TIMEOUT') {
            		$("#status").addClass("label-danger");
           		}
            	if (source.Status == 'NO_PDU' || source.Status == 'NO_IFTABLE') {
            		$("#status").addClass("label-warning");
            	}            
            	if (source.sysName) {
            		$("#sysName").text(source.sysName);
            		$("#ifNumber").text(source.ifNumber);
            		$("#sysUptime").text(uptime(source.sysUptime));
            		$("#sysDescr").text(source.sysDescr);
            	}
            }
         }
    });
       
 	var dt = $('#ifTable').DataTable({
       ajax: {
        url: "/api/v1/sources/"+ip+"/interfaces",
        //dataSrc: '' 
        dataSrc: function(ifTable) {
          ifTable.forEach(function(ifEntry){
          	//ifEntry.ifDescr = "<span class=\"glyphicon glyphicon-collapse-down\" aria-hidden=\"true\"></span> "+ifEntry.ifDescr;
          	ifEntry.ifDescr += (ifEntry.ifAlias)?" ("+ifEntry.ifAlias+")":"";
            ifEntry.pollStatus = (ifEntry.ifAdminStatus==1 && ifEntry.ifOperStatus==1)?"<span class=\"text-info\">up</span>":"<span class=\"text-danger\">down</span>";
            ifEntry.bytes_in = Number.parseInt(ifEntry.pollInOctets).toLocaleString('en-EN');
            ifEntry.bytes_out = Number.parseInt(ifEntry.pollOutOctets).toLocaleString('en-EN');
            //console.log();
          });
          return ifTable;
        }
       },
       lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
       columns: [
       	{ "class":"detail","orderable":false,"data":null,
          "defaultContent": "<span class=\"glyphicon glyphicon-collapse-down\" aria-hidden=\"true\"></span>"},
        { data:"ifIndex" },
       	{ data:"ifDescr" },
       	//{ data: "ifName" },
       	{ data: "pollStatus" },
       	{ data: "bytes_in" },
       	{ data: "bytes_out" }
       ],
       "order": [[1, 'asc']]
    });

	function ifstatus(s) {
		if (s == 1) return "(<b>up</b>)";
		return "(<b>down</b>)";
	}
	function format(d) {
		return "<pre>ifAdminStatus="+d.ifAdminStatus+ifstatus(d.ifAdminStatus==1)
			+" ifOperStatus="+d.ifOperStatus+ifstatus(d.ifOperStatus)
			+" ifInOctets=<b>"+d.ifInOctets.value+"</b> type="+d.ifInOctets.type
			+" ifOutOctets=<b>"+d.ifOutOctets.value+"</b> type="+d.ifOutOctets.type
			+"</pre>";
	}
	
	// Array to track the ids of the details displayed rows
    var detailRows = [];
    
	$('#ifTable tbody').on( 'click', 'tr td.detail' , function () {
        var tr = $(this).closest('tr');
        var btn = $(this).children();
        var row = dt.row( tr );
        var idx = $.inArray( tr.attr('id'), detailRows );
        if ( row.child.isShown() ) {
        	btn.removeClass('glyphicon-collapse-up');
        	btn.addClass('glyphicon-collapse-down');
            row.child.hide();
            // Remove from the 'open' array
            detailRows.splice( idx, 1 );
        } else {
       		btn.removeClass('glyphicon-collapse-down');
        	btn.addClass('glyphicon-collapse-up');
        	row.child( format( row.data() ) ).show();
 
            // Add to the 'open' array
            if ( idx === -1 ) {
                detailRows.push( tr.attr('id') );
            }
        }
    } );
    </script>
  </body>
</html>
