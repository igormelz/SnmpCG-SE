<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel='shortcut icon' href='img/favicon.ico' type='image/x-icon'/>

    <title>SnmpCG - Admin Interface</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/vendor/bootstrap.min.css" rel="stylesheet">
    <link href="css/dataTables.bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
      <script src="js/vendor/html5shiv.js"></script>
      <script src="js/vendor/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html">SnmpCG</a>
        </div>
        <ul class="nav navbar-nav">
          <li><a href="index.html">Sources</a></li>
          <li><a href="charging.html">ChargeIF</a></li>
        </ul>
        <button id="removeBtn" type="button" class="btn btn-primary navbar-btn navbar-right" onclick="delSource()">Remove</button>
      </div>
    </nav>
    <!-- page content -->
    <div class="container">
        	<h2>Source <span id="address"></span></h2>
			<h5>last poll @ <span id="updated"></span></h5>
		<div class="panel panel-default">
  			<div class="panel-heading"><span id="status" class="label"></span> <span id="sysName"></span></div>
  			<div class="panel-body">
    			<span id="sysDescr" class="small"></span>
  			</div>
			<ul class="list-group">
				<li class="list-group-item small"><label>Uptime:</label><span id="sysUptime"></span></li>
				<li class="list-group-item">
				<div class="btn-group-sm" data-toggle="buttons">
        		<btn type="radio" class="btn btn-default" id="ifAll">ifNumber: <span id="ifNumber" class="badge info"></span></btn>
        		<btn type="radio" class="btn btn-success" id="ifUp">ifNumberUp <span id="pollUp" class="badge info">0</span></btn>
        		<btn type="radio" class="btn btn-warning" id="ifDown">ifNumberDown <span id="pollDown" class="badge info">0</span></btn>
        		</div>
        	</ul>
		</div>
		<table id="ifTable" class="table table-condensed">
          <thead>
            <tr>
              <th>ifIndex</th>
               <th></th>
              <th>ifDescr</th>
              <th>ifStatus</th>
              <th>in (MB/s)</th>
              <th>out (MB/s)</th>
            </tr>
          </thead>
          <tbody>
          </tbody>  
        </table>
		</div>
    </div>
    <!-- /.container -->

    <!-- jQuery (necessary for Flat UI's JavaScript plugins) -->
    <script src="js/vendor/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/datatables.min.js"></script>
    <!-- script src="js/jquery.dataTables.min.js"></script -->
    <script src="js/dataTables.bootstrap.min.js"></script>
    <script src="js/script.js"></script>
    <script>

    var ip = getUrlParameter("ip");
    $("#address").text(ip);
    $("#removeBtn").text("Remove "+ip);
    
    function delSource() {
    	$.ajax({
    		url: "/api/v1/sources/"+ip,
    		type: "DELETE",
    		success: function(result) {
    			window.location.href = "index.html";
    		}
		});
    }
    
    $.ajax({
    	url: "/api/v1/sources/"+ip,
    	success: function(source){
    		$("#status").text(source.Status);
    		if (source.Status == 'UNKNOWN') {
            	$("#status").addClass("label-default");
            } 
            else {
    			$("#updated").text(new Date(source.pollTime).toLocaleString());
 				if (source.Status == 'SUCCESS') {
            		$("#status").addClass("label-success");
            	} 
            	if (source.Status == 'TIMEOUT') {
            		$("#status").addClass("label-danger");
           		}
            	if (source.Status == 'NO_PDU' || source.Status == 'NO_IFTABLE') {
            		$("#status").addClass("label-warning");
            	}            
            	if (source.sysName) {
            		$("#sysName").text(source.sysName);
            		$("#ifNumber").text(source.ifNumber);
            		$("#sysUptime").text(uptime(source.sysUptime));
            		$("#sysDescr").text(source.sysDescr);
            		$("#pollUp").text(source.pollStatusUp);
            		$("#pollDown").text(source.pollStatusDown);
            	}
            }
         }
    });
    
 	var dt = $('#ifTable').DataTable({
       ajax: {
        url: "/api/v1/sources/"+ip+"/interfaces",
        //dataSrc: '' 
        dataSrc: function(ifTable) {
          ifTable.forEach(function(ifEntry){
          	ifEntry.ifDescr += (ifEntry.ifAlias)?" ("+ifEntry.ifAlias+")":"";
            ifEntry.pollStatus = (ifEntry.up)?"<span class=\"text-info\">up</span>":"<span class=\"text-danger\">down</span>";
            ifEntry.bytes_in = bandwith(ifEntry.pollInOctets);
            ifEntry.bytes_out = bandwith(ifEntry.pollOutOctets);
            //console.log(bandwith(ifEntry.pollOutOctets));
          });
          return ifTable;
        }
       },
       lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
       columns: [
        { data:"ifIndex" },
        { "class":"detail","orderable":false,"data":null,
          "defaultContent": "<span class=\"glyphicon glyphicon-collapse-down\" aria-hidden=\"true\"></span>"},
       	{ data:"ifDescr" },
       	//{ data: "ifName" },
       	{ data: "pollStatus" },
       	{ data: "bytes_in" },
       	{ data: "bytes_out" }
       ],
       "order": [[5, 'desc']]
    });

	function ifstatus(s) {
		if (s == 1) return "(<b>up</b>)";
		return "(<b>down</b>)";
	}
	
	function format(d) {
		return "<pre>ifAdminStatus="+d.ifAdminStatus+ifstatus(d.ifAdminStatus)
			+" ifOperStatus="+d.ifOperStatus+ifstatus(d.ifOperStatus)
			+" pollInOctets="+d.pollInOctets
			+" pollOutOctets="+d.pollOutOctets //Number.parseInt(d.pollOutOctets).toLocaleString('en-EN')
			//+" ifInOctets=<b>"+d.ifInOctets.value+"</b> type="+d.ifInOctets.type
			//+" ifOutOctets=<b>"+d.ifOutOctets.value+"</b> type="+d.ifOutOctets.type
			+"</pre>";
	}
	
	// Array to track the ids of the details displayed rows
    var detailRows = [];
    
	$('#ifTable tbody').on( 'click', 'tr td.detail' , function () {
        var tr = $(this).closest('tr');
        var btn = $(this).children();
        var row = dt.row( tr );
        var idx = $.inArray( tr.attr('id'), detailRows );
        if ( row.child.isShown() ) {
        	btn.removeClass('glyphicon-collapse-up');
        	btn.addClass('glyphicon-collapse-down');
            row.child.hide();
            // Remove from the 'open' array
            detailRows.splice( idx, 1 );
        } else {
       		btn.removeClass('glyphicon-collapse-down');
        	btn.addClass('glyphicon-collapse-up');
        	row.child( format( row.data() ) ).show();
 
            // Add to the 'open' array
            if ( idx === -1 ) {
                detailRows.push( tr.attr('id') );
            }
        }
    } );
    
    $('#ifUp').on('click', function () {
        dt.ajax.url( "/api/v1/sources/"+ip+"/interfaces?pollStatus=up" ).load();  
    });
    $('#ifDown').on('click', function () {
        dt.ajax.url( "/api/v1/sources/"+ip+"/interfaces?pollStatus=down" ).load();  
    });
    $('#ifAll').on('click', function () {
        dt.ajax.url( "/api/v1/sources/"+ip+"/interfaces" ).load();  
    });
    
    </script>
  </body>
</html>
