<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="OpenFS">
<link rel='shortcut icon' href='img/favicon.ico' type='image/x-icon' />

<title>SnmpCG - Admin Interface</title>

<!-- Bootstrap Core CSS -->
<link href="css/vendor/bootstrap.min.css" rel="stylesheet" />
<link href="css/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="css/style.css" rel="stylesheet" />

<script src="js/vendor/jquery.min.js"></script>
<script src="js/vendor/bootstrap.min.js"></script>
<script src="js/vendor/datatables.min.js"></script>
<script src="js/vendor/jquery.dataTables.min.js"></script>
<script src="js/vendor/dataTables.bootstrap.min.js"></script>
<script src="js/script.js"></script>
<!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
<!--[if lt IE 9]>
      <script src="js/vendor/html5shiv.js"></script>
      <script src="js/vendor/respond.min.js"></script>
    <![endif]-->
</head>
<body>
	<!-- Navigation -->
	<nav class="navbar navbar-default" role="navigation">
		<div class="container">
			<!-- brand -->
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">SnmpCG</a>
			</div>
			<!-- nav links -->
			<ul class="nav navbar-nav">
				<li class="active"><a href="index.html">Sources</a></li>
				<li><a href="counters.html">PollCounters</a></li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a href="cluster.html">Node status: <strong
						id="clusterInfo"></strong></a></li>
			</ul>
		</div>
		<!-- /.container -->
	</nav>

	<!-- page content -->
	<div class="container">
		<div class="row">
			<ul class="nav nav-pills">
				<li><a href="#" class="text-default" data-toggle="modal"
					title="add source" id="addNewBtn" data-target="#addNewSource"><span
						class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add</a></li>
				<li><a href="#" title="view all sources" id="filter_all"
					class="text-info"> No Filter <span id="allVal" class="badge"></span>
				</a></li>
				<li><a href="#" title="view up sources" id="filter_success"
					class="text-primary"> <span class="glyphicon glyphicon-filter"
						aria-hidden="true"></span> Success <span id="successVal"
						class="badge"></span>
				</a></li>
				<li><a href="#" title="view down sources" id="filter_timeout"
					class="text-danger"> <span class="glyphicon glyphicon-filter"
						aria-hidden="true"></span> Error <span id="timeoutVal"
						class="badge"></span>
				</a></li>
				<li><a href="#" title="view pending status sources"
					id="filter_unknown" class="text-muted"> <span
						class="glyphicon glyphicon-filter" aria-hidden="true"></span>
						Pending <span id="unknownVal" class="badge"></span>
				</a></li>
			</ul>
		</div>

		<table id="ifTable" class="table table-condensed">
			<thead>
				<tr>
					<td></td>
					<td>Source</td>
					<td>SourceInfo</td>
					<td>last poll</td>
					<td>status</td>
					<td>response (ms)</td>
					<td>Charge/Trace</td>
					<td></td>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
	<!-- /.container -->

	<!-- Modal -->
	<div class="modal fade" id="addNewSource" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">Add source to SnmpCG</h4>
				</div>
				<form id="newSourceForm">
					<div class="modal-body">
						<label for="new_source">Source ipAddress</label><em> (<span
							style="color: red">*</span>required)
						</em>
						<div class="form-group">
							<input id="new_source" type="text" class="form-control"
								required="required" placeholder="0.0.0.0">
						</div>
						<label>Custom fields</label><em> (<span style="color: red">*</span>required)
						</em>
						<div class="form-group" id="customFields"></div>
						<label for="community">SNMP parameters</label>
						<div class="form-group">
							<input disabled id="community" type="text" class="form-control"
								placeholder="community-string" />
						</div>
						<div class="form-group">
							<input disabled id="retries" type="text" class="form-control"
								placeholder="num retries" />
						</div>
						<div class="form-group">
							<input disabled id="timeout" type="text" class="form-control"
								placeholder="timeout in sec"> <label><input
								id="useSystemCommunity" type="checkbox" checked /> use system
								default</label>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button class="btn btn-primary" type="submit" data-dismiss="modal"
							onclick="addSource()">Add source</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal fade" id="askToRemove" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">Remove source from
						SnmpCG</h4>
				</div>
				<div class="modal-footer">
					<form>
						<input type="hidden" id="ipToRemove" />
						<button type="button" class="btn btn-default" data-dismiss="modal">No,
							return</button>
						<button class="btn btn-danger" type="submit" data-dismiss="modal"
							onclick="deleteSource()">Yes, remove</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- edit -->
	<div class="modal fade" id="editSource" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel1">Change Source
						Settings</h4>
				</div>
				<div class="modal-body">
					<label>Source ipAddress:</label>
					<div class="form-group">
						<input readonly="readonly" class="form-control" type="text"
							id="sourceIpAddress">
					</div>
					<label>Custom fields</label>
					<div class="form-group" id="sourceCustomFields"></div>
					<label for="community">SNMP parameters</label>
					<div class="form-group">
						<input id="sourceCommunity" type="text" class="form-control"
							placeholder="community-string" />
					</div>
					<div class="form-group">
						<input id="sourceRetries" type="text" class="form-control"
							placeholder="num retries" />
					</div>
					<div class="form-group">
						<input id="sourceTimeout" type="text" class="form-control"
							placeholder="timeout in sec">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button class="btn btn-primary" type="submit" data-dismiss="modal"
						onclick="updateSource()">Update</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		// onLoad
		fillCounter();
		getConfig();
		clusterInfo();

		var tagkeys = [];
		function addField(name) {
			var field = "<div class='input-group'><span class='input-group-addon'>"
					+ name
					+ "</span>"
					+ "<input id='"+name+"' name='"+name+"' type='text' class='form-control' placeholder='field-value'></div>";

			$('#customFields').append(field);
			$('#sourceCustomFields').append(field);
			tagkeys.push(name);
			console.log("add field " + name);
		}

		$('#useSystemCommunity').on('click', function() {
			if (this.checked) {
				$('#community').prop('disabled', true);
				$('#retries').prop('disabled', true);
				$('#timeout').prop('disabled', true);
			} else {
				$('#community').prop('disabled', false);
				$('#retries').prop('disabled', false);
				$('#timeout').prop('disabled', false);
			}
		});

		function updateSource() {
			var source = $('#sourceIpAddress').val();
			var community = $('#sourceCommunity').val();
			var retries = $('#sourceRetries').val();
			var timeout = $('#sourceTimeout').val();

			var jsonData = "{";
			if (community != null && community != '') {
				jsonData += "\"community\":\"" + community + "\"";
			}
			if (retries != null && retries != '') {
				jsonData += ",\"retries\":" + parseInt(retries) + "";
			}
			if (timeout != null && timeout != '') {
				jsonData += ",\"timeout\":" + parseInt(timeout) + "";
			}
			jsonData += ",\"tags\":{";
			tagkeys.forEach(function(item, idx, arr) {
				jsonData += "\"" + item + "\":\""
						+ addslashes($("#sourceCustomFields #" + item).val())
						+ "\"";
				if (idx != tagkeys.length - 1) {
					jsonData += ",";
				}
			});
			jsonData += "}}";
			console.log("Update:" + jsonData);
			$.ajax({
				url : "/api/v1/sources/" + source,
				type : 'PUT',
				contentType : "application/json",
				data : jsonData,
				success : function() {
					bootstrap_alert.warning('Source add to poll', 'success',
							3000);
					fillCounter();
					dt.ajax.url('/api/v1/sources').load();
				},
				error : function(xhr) {
					bootstrap_alert.warning(xhr.statusText, 'error', 3000);
				}
			});
		}

		function addSource() {
			var source = $('#new_source').val();
			var community = $('#community').val();
			var retries = $('#retries').val();
			var timeout = $('#timeout').val();

			//console.log(tags);

			if (validateIPaddress(source)) {
				//var jsonData = JSON.stringify({"ipaddr":source, "community":action});
				var jsonData = "{\"ipaddr\":\"" + source + "\"";
				if (community != null && community != '') {
					jsonData += ",\"community\":\"" + community + "\"";
				}
				if (retries != null && retries != '') {
					jsonData += ",\"retries\":" + parseInt(retries) + "";
				}
				if (timeout != null && timeout != '') {
					jsonData += ",\"timeout\":" + parseInt(timeout) + "";
				}
				jsonData += ",\"tags\":{";
				tagkeys.forEach(function(item, idx, arr) {
					jsonData += "\"" + item + "\":\""
							+ addslashes($("input[id='" + item + "']").val())
							+ "\"";
					if (idx != tagkeys.length - 1) {
						jsonData += ",";
					}
				});
				jsonData += "}}";

				console.log("add source: " + jsonData);
				$.ajax({
					url : "/api/v1/sources", //+source+queryStr,
					type : 'POST',
					contentType : "application/json",
					data : jsonData,
					success : function() {
						bootstrap_alert.warning('Source add to poll',
								'success', 3000);
						fillCounter();
						dt.ajax.url('/api/v1/sources').load();
					}
				});
			} else {
				bootstrap_alert.warning('Wrong IP format: ' + source,
						'warning', 3000);
			}
		}

		function deleteSource() {
			var source = $('#ipToRemove').val();
			if (source != null && source != "") {
				$.ajax({
					url : "/api/v1/sources/" + source,
					type : "DELETE",
					success : function() {
						bootstrap_alert.warning('Source deleted', 'success',
								3000);
						fillCounter();
						dt.ajax.url('/api/v1/sources').load();
					}
				});
			}
		}

		function getConfig() {
			$.ajax({
				url : "/api/v1/sources/config",
				success : function(conf) {
					conf.sourceTagKeys.forEach(function(key) {
						addField(key);
					});
					$('#community').val(conf.snmpCommunity);
					$('#retries').val(conf.snmpRetries);
					$('#timeout').val(conf.snmpTimeout);
				}
			});
		}

		// fill counter
		function fillCounter() {
			$
					.ajax({
						url : "/api/v1/sources?stats",
						success : function(stats) {
							var up = (stats.SUCCESS) ? parseInt(stats.SUCCESS)
									: 0;
							var pending = (stats.UNKNOWN) ? parseInt(stats.UNKNOWN)
									: 0;
							var down = (stats.TIMEOUT) ? parseInt(stats.TIMEOUT)
									: 0;
							down += (stats.NO_PDU) ? parseInt(stats.NO_PDU) : 0;
							down += (stats.NO_IFTABLE) ? parseInt(stats.NO_IFTABLE)
									: 0;
							$('#allVal').text(up + pending + down);
							$('#successVal').text(up);
							$('#timeoutVal').text(down);
							$('#unknownVal').text(pending);
						}
					});
		}

		var dt = $('#ifTable')
				.DataTable(
						{
							ajax : {
								url : "/api/v1/sources",
								dataSrc : function(sources) {
									sources
											.forEach(function(source) {
												source.viewSrc = "<a title=\"click to view interfaces\" href=\"view.html?ip=";
												source.viewSrc += source.Ip;
												source.viewSrc += "\"><span class=\"glyphicon glyphicon-list\" aria-hidden=\"true\"></span></a>";

												source.actionSrc = "<a href='#' id='editSrc' title='Change settings'><span class=\"glyphicon glyphicon-edit\" aria-hidden=\"true\"></span></a>";
												source.actionSrc += "&nbsp;&nbsp;<a href='#' class='text-danger' id='delSrc' title='Remove source'><span class=\"glyphicon glyphicon-remove\" aria-hidden=\"true\"></span></a>";
												switch (source.Status) {
												case 'SUCCESS':
													source.Status = "<span class=\"label label-success small\">"
															+ source.Status
															+ "</span>";
													break;
												case 'TIMEOUT':
													source.Status = "<span class=\"label label-danger small\">"
															+ source.Status
															+ "</span>";
													break;
												case 'NO_PDU':
													source.Status = "<span class=\"label label-warning small\">"
															+ source.Status
															+ "</span>";
													break;
												case 'NO IFTABLE':
													source.Status = "<span class=\"label label-warning small\">"
															+ source.Status
															+ "</span>";
													break;
												case 'UNKNOWN':
													source.Status = "<span class=\"label label-default small\">"
															+ source.Status
															+ "</span> ";
												}
												source.SourceInfo = source.viewSrc
														+ "&nbsp;";
												source.SourceInfo += (source.sysName) ? source.sysName
														+ " ["
														+ source.Ip
														+ "]"
														: source.Ip;
												source.sourceTags = "";
												Object
														.keys(source.tags)
														.forEach(
																function(item) {
																	source.sourceTags += "<span title='"+item+"'>";
																	source.sourceTags += source.tags[item]
																			+ "</span>&nbsp;";
																});
												source.counters = source.chargeableCounter
														+ "/"
														+ source.traceCounter;
												source.pollTime = new Date(
														source.pollTime)
														.toLocaleString();
											});
									return sources;
								}
							},
							lengthChange : false,
							paging : false,
							columns : [
									{
										"class" : "detail",
										"orderable" : false,
										"data" : null,
										"defaultContent" : "<span title=\"click to view details\" class=\"glyphicon glyphicon-chevron-right\" aria-hidden=\"true\"></span>"
									}, {
										data : "SourceInfo"
									}, {
										data : "sourceTags"
									}, {
										data : "pollTime"
									}, {
										"data" : "Status"
									}, {
										data : "pollResponse"
									}, {
										data : "counters"

									}, {
										"orderable" : false,
										"data" : "actionSrc"
									} ],
							"order" : [ [ 1, 'asc' ] ]
						});

		function format(source) {
			var answer = "<ul class=\"list-group small\">";
			answer += "<li class=\"list-group-item\"><label>sysDescr:</label> ";
			answer += source.sysDescr + "</li>";
			answer += "<li class=\"list-group-item\"><label>sysUpTime:</label> ";
			answer += uptime(source.sysUptime) + "</li>";
			answer += "<li class=\"list-group-item\"><label>ifNumber:</label> ";
			answer += source.ifNumber + " [up:" + source.statusUpCounter
					+ "]</li>";
			answer += "</ul>";
			return answer;
		}

		$('#ifTable tbody').on(
				'click',
				'tr #delSrc',
				function() {
					var ip = dt.row($(this).closest('tr')).data().Ip;
					console.log("try to remove:" + ip);
					jQuery.noConflict();
					$("#askToRemove").find('.modal-title').text(
							'Remove ' + ip + ' from SnmpCG');
					$("#askToRemove").find('.modal-footer input').val(ip);
					$("#askToRemove").modal();
				});

		$('#ifTable tbody').on('click', 'tr #editSrc', function() {
			var data = dt.row($(this).closest('tr')).data();
			jQuery.noConflict();
			$("#sourceIpAddress").val(data.Ip);
			$("#sourceCommunity").val(data.snmpCommunity);
			$('#sourceRetries').val(data.snmpRetries);
			$('#sourceTimeout').val(data.snmpTimeout);
			tagkeys.forEach(function(item) {
				$("#sourceCustomFields #" + item).val(data.tags[item]);
			});
			$("#editSource").modal();
		});

		// Array to track the ids of the details displayed rows
		var detailRows = [];

		$('#ifTable tbody').on('click', 'tr td.detail', function() {
			var tr = $(this).closest('tr');
			var row = dt.row(tr);
			var idx = $.inArray(tr.attr('id'), detailRows);
			if (row.child.isShown()) {
				row.child.hide();
				// Remove from the 'open' array
				detailRows.splice(idx, 1);
			} else {
				row.child(format(row.data())).show();
				// Add to the 'open' array
				if (idx === -1) {
					detailRows.push(tr.attr('id'));
				}
			}
		});

		$('#filter_all').on('click', function() {
			fillCounter();
			dt.ajax.url('/api/v1/sources').load();
			//dt.column(3).visible(true);
		});
		$('#filter_success').on('click', function() {
			fillCounter();
			dt.ajax.url('/api/v1/sources?status=SUCCESS').load();
			//dt.column(3).visible(false);
		});
		$('#filter_timeout').on('click', function() {
			fillCounter();
			dt.ajax.url('/api/v1/sources?status=TIMEOUT').load();
			//dt.column(3).visible(false);
		});
		$('#filter_unknown').on('click', function() {
			fillCounter();
			dt.ajax.url('/api/v1/sources?status=UNKNOWN').load();
			//dt.column(3).visible(false);
		});
	</script>
</body>
</html>
